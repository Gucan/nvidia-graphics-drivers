From bb4ec858adefe35f83ecebd8f49748c10d6595df Mon Sep 17 00:00:00 2001
From: Alberto Milone <alberto.milone@canonical.com>
Date: Thu, 24 Nov 2016 11:45:25 +0100
Subject: [PATCH 1/1] Add support for Linux 4.9

---
 nv-drm.c   | 4 ++++
 nv-linux.h | 5 +++++
 os-mlock.c | 4 ++++
 3 files changed, 13 insertions(+)

diff --git a/nv-drm.c b/nv-drm.c
index 4c1a3ae..ea9f17e 100644
--- a/nv-drm.c
+++ b/nv-drm.c
@@ -115,7 +115,11 @@ static const struct file_operations nv_drm_fops = {
 };
 
 static struct drm_driver nv_drm_driver = {
+#if LINUX_VERSION_CODE >= KERNEL_VERSION(4, 9, 0)
+    .driver_features = DRIVER_GEM | DRIVER_PRIME | DRIVER_LEGACY,
+#else
     .driver_features = DRIVER_GEM | DRIVER_PRIME,
+#endif
     .load = nv_drm_load,
     .unload = nv_drm_unload,
     .fops = &nv_drm_fops,
diff --git a/nv-linux.h b/nv-linux.h
index e7f96fd..028700a 100644
--- a/nv-linux.h
+++ b/nv-linux.h
@@ -2065,8 +2065,13 @@ static inline NvU64 nv_node_end_pfn(int nid)
     #define NV_GET_USER_PAGES           get_user_pages
     #define NV_GET_USER_PAGES_REMOTE    get_user_pages_remote
 #else
+#if LINUX_VERSION_CODE >= KERNEL_VERSION(4, 9, 0)
+    #define NV_GET_USER_PAGES(start, nr_pages, gup_flags, pages, vmas) \
+        get_user_pages(current, current->mm, start, nr_pages, gup_flags, pages, vmas)
+#else
     #define NV_GET_USER_PAGES(start, nr_pages, write, force, pages, vmas) \
         get_user_pages(current, current->mm, start, nr_pages, write, force, pages, vmas)
+#endif
 
     #define NV_GET_USER_PAGES_REMOTE    get_user_pages
 #endif
diff --git a/os-mlock.c b/os-mlock.c
index 8a1fa2f..894e69a 100644
--- a/os-mlock.c
+++ b/os-mlock.c
@@ -46,7 +46,11 @@ RM_STATUS NV_API_CALL os_lock_user_pages(
 
     down_read(&mm->mmap_sem);
     ret = NV_GET_USER_PAGES((unsigned long)address,
+#if LINUX_VERSION_CODE >= KERNEL_VERSION(4, 9, 0)
+                            page_count, write ? FOLL_WRITE : 0, user_pages, NULL);
+#else
                             page_count, write, force, user_pages, NULL);
+#endif
     up_read(&mm->mmap_sem);
     pinned = ret;
 
-- 
2.7.4

